import{r,j as n}from"./index-WZ944UgW.js";import{u as P,U as he,g as ia,b as la,a as da,c as ca,r as L,t as ve,s as ga,O as ua,e as ma,d as pa,S as fa,V as ha}from"./telegramService-Ba9-Zoq2.js";import{n as va,o as wa,p as ba,q as ya,c as xa,I as Sa,m as Ia,r as Va}from"./lehuyducanhService-p9mbsEAy.js";import{r as x,i as ja,f as we,d as be}from"./media-CDZXYBSY.js";import{I as ye}from"./ImageUpload-DksvPInp.js";import{s as xe}from"./settingsService-CbIZ9NBp.js";import"./streetInterviewPrompts-Dzu83YwK.js";const Ua=(w,M)=>new Promise((V,m)=>{const u=document.createElement("video");u.preload="metadata",u.src=URL.createObjectURL(w),u.muted=!0;const N=document.createElement("canvas"),E=N.getContext("2d"),F=[];u.onloadedmetadata=()=>{N.width=u.videoWidth,N.height=u.videoHeight;const S=u.duration;if(!S||S===1/0)return URL.revokeObjectURL(u.src),m("Could not determine video duration.");const R=Math.floor(S*M),b=1/M;let A=0,d=0;const C=()=>{if(d>=R||A>S){URL.revokeObjectURL(u.src),V(F);return}u.currentTime=A};u.onseeked=()=>{if(!E)return URL.revokeObjectURL(u.src),m("Canvas context not available");E.drawImage(u,0,0,u.videoWidth,u.videoHeight),F.push(N.toDataURL("image/jpeg",.8)),d++,A+=b,C()},u.onerror=p=>{URL.revokeObjectURL(u.src),m("Error loading or seeking video for frame capture.")},C()},u.onerror=S=>{URL.revokeObjectURL(u.src),m("Error loading video metadata.")}}),Da=({currentUser:w,onLogout:M})=>{const[V,m]=r.useState("upload"),[u,N]=r.useState(null),[E,F]=r.useState(null),[S,R]=r.useState(!1),[b,A]=r.useState(null),[d,C]=r.useState(null),[p,O]=r.useState(null),[f,X]=r.useState(""),[j,_]=r.useState(""),[U,$]=r.useState(""),[Se,Y]=r.useState(!1),[Ie,ee]=r.useState(!1),[I,Ve]=r.useState("9:16"),[G,z]=r.useState(""),[ae,te]=r.useState(!1),[c,g]=r.useState([]),[oe,ne]=r.useState(!1),[K,h]=r.useState(null),[D,je]=r.useState("Kore"),[J,Ue]=r.useState({}),[re,se]=r.useState(null),[Ge,ie]=r.useState(!1),[Ne,le]=r.useState(!1),[Ae,de]=r.useState(!1),[Ce,ce]=r.useState(!1),[ke,ge]=r.useState(!1),[Ga,ue]=r.useState(!1),[Na,me]=r.useState(!1),[Te,pe]=r.useState(!1),[Ee,fe]=r.useState(!1),[Aa,Pe]=r.useState({storyboard:0,image:0,video:0}),k=r.useCallback(()=>{if(w){const e=P.getUsage(w);Pe({storyboard:e.generateStoryboard.count,image:e.generateImage.count,video:e.generateVideo.count})}},[w]);r.useEffect(()=>{k()},[w,k]);const Fe=e=>{var o;const a=(o=e.target.files)==null?void 0:o[0];a&&a.type.startsWith("video/")?(N(a),F(URL.createObjectURL(a)),h(null)):h("Please upload a valid video file.")},Re=async()=>{if(u){R(!0),h(null);try{const a=await Ua(u,2),o=a.length/2,t=await Va(a,2,o);A(t),m("input")}catch(e){h(e instanceof Error?e.message:"An unknown error occurred during video analysis.")}finally{R(!1)}}},De=r.useCallback(async()=>{if(!(!d||!f)){Y(!0);try{const e=await x(d),a=await va(f,e);$(a)}catch(e){h(e instanceof Error?e.message:"Failed to suggest target audience.")}finally{Y(!1)}}},[d,f]),Be=r.useCallback(async()=>{if(!(!d||!f)){ee(!0);try{const e=await x(d),a=await wa(f,e);_(a)}catch(e){h(e instanceof Error?e.message:"Failed to suggest key message.")}finally{ee(!1)}}},[d,f]),Le=r.useCallback(async()=>{if(!(!b||!d||!j)){te(!0),h(null);try{const e=await x(d),a=p?await x(p):void 0,o=await ba(b,j,e,f,U,a);z(o),m("script")}catch(e){h(e instanceof Error?e.message:"Failed to generate cloned script.")}finally{te(!1)}}},[b,j,d,f,U,p]),Me=r.useCallback(async()=>{if(!(!b||!G||!d)){ne(!0),h(null);try{const e=await x(d),a=p?await x(p):void 0,o=await ya(b,G,e,f,U,a);g(o),m("storyboard")}catch(e){h(e instanceof Error?e.message:"Failed to generate storyboard.")}finally{ne(!1)}}},[b,G,d,f,U,p]),W=r.useCallback(async e=>{if(!P.canPerformAction(w,"generateImage"))throw new Error(`Daily image generation limit of ${he.generateImage} reached.`);const a=c.find(o=>o.id===e);if(a){g(o=>o.map(t=>t.id===e?{...t,isGeneratingImage:!0,imageGenerationError:null}:t));try{const t=(J[e]||{}).imageProvider||"lehuyducanh",s=[];d&&s.push(await x(d)),p&&s.push(await x(p));const i=await ia({provider:t,prompt:a.imagePrompt,subjectUrls:s,aspectRatio:I});g(l=>l.map(v=>v.id===e?{...v,images:[...v.images,...i],isGeneratingImage:!1}:v)),P.logAction(w,"generateImage"),k()}catch(o){const t=o instanceof Error?o.message:"Unknown image generation error.";throw g(s=>s.map(i=>i.id===e?{...i,isGeneratingImage:!1,imageGenerationError:t}:i)),o}}},[c,J,d,p,I,w,k]),Oe=(e,a)=>{g(o=>o.map(t=>{if(t.id!==e)return t;const s=[...t.videos];return s.splice(a,1),{...t,videos:s}}))},H=r.useCallback(async e=>{if(!P.canPerformAction(w,"generateVideo"))throw new Error(`Daily video generation limit of ${he.generateVideo} reached.`);const a=c.find(o=>o.id===e);if(!a||!a.selectedImageForVideo)throw new Error("No image selected for video generation.");g(o=>o.map(t=>t.id===e?{...t,isGeneratingVideo:!0,videoGenerationError:null}:t));try{const o=await ja(a.selectedImageForVideo),t=`{
  "voiceover": ${JSON.stringify(a.voiceoverScript)},
  "motion_action": ${JSON.stringify(a.videoPrompt)},
  "audio": {
    "background_music": "none",
    "allow_music": false,
    "allow_sound_effects": true,
    "allow_voiceover": true,
    "policy": "no_music_background_only_sfx_and_voice"
  }
}`,{videoUrl:s,upscaledUrl:i,mediaGenerationId:l,seed:v,publicUrl:y,upscaledPublicUrl:T}=await la({provider:"lehuyducanh",prompt:t,imageUrl:o,upscale:a.shouldUpscaleVideo,aspectRatio:I}),Q={url:y||s,mediaGenerationId:l,seed:v,upscaledUrl:T||i};g(ra=>ra.map(B=>{if(B.id!==e)return B;const sa=[...B.videos,Q];return{...B,videos:sa,isGeneratingVideo:!1}})),P.logAction(w,"generateVideo"),k()}catch(o){const t=o instanceof Error?o.message:"An unknown error occurred.";throw g(s=>s.map(i=>i.id===e?{...i,isGeneratingVideo:!1,videoGenerationError:t}:i)),o}},[c,w,k,I]),Z=r.useCallback(async(e,a)=>{const o=c.find(s=>s.id===e),t=o==null?void 0:o.videos[a];if(t){g(s=>s.map(i=>i.id===e?{...i,videos:i.videos.map((l,v)=>v===a?{...l,isUpscaling:!0,upscaleError:null}:l)}:i));try{const{videoUrl:s,publicUrl:i}=await da({provider:"lehuyducanh",mediaGenerationId:t.mediaGenerationId,seed:t.seed}),l=i||s;g(v=>v.map(y=>y.id===e?{...y,videos:y.videos.map((T,Q)=>Q===a?{...T,upscaledUrl:l,isUpscaling:!1}:T)}:y))}catch(s){const i=s instanceof Error?s.message:"An unknown error occurred during upscale.";throw g(l=>l.map(v=>v.id===e?{...v,videos:v.videos.map((y,T)=>T===a?{...y,isUpscaling:!1,upscaleError:i}:y)}:v)),s}}},[c]),q=r.useCallback(async e=>{const a=c.find(o=>o.id===e);if(a){g(o=>o.map(t=>t.id===e?{...t,isGeneratingAudio:!0,audioGenerationError:null}:t));try{const o=await xa(a.voiceoverScript,a.voiceoverGuide,D),t=ca(o),s=URL.createObjectURL(t);g(i=>i.map(l=>l.id===e?{...l,audioUrl:s,isGeneratingAudio:!1}:l))}catch(o){const t=o instanceof Error?o.message:"An unknown audio generation error occurred.";g(s=>s.map(i=>i.id===e?{...i,isGeneratingAudio:!1,audioGenerationError:t}:i))}}},[c,D]),_e=e=>{g(a=>{const o=a.length?a[Math.max(0,Math.min(e-1,a.length-1))]:void 0,t=o?{...o,id:crypto.randomUUID?crypto.randomUUID():`scene-${Date.now()}`,images:[...o.images],videos:(o.videos||[]).map(i=>({...i,isUpscaling:!1,upscaleError:null})),isGeneratingImage:!1,imageGenerationError:null,isGeneratingVideo:!1,videoGenerationError:null,isGeneratingAudio:!1,audioGenerationError:null,audioUrl:o.audioUrl}:Ia({voiceoverScript:"New scene"}),s=[...a];return s.splice(e,0,t),s})},$e=r.useCallback(async()=>{le(!0);const e=c.filter(a=>a.images.length===0).map(a=>()=>W(a.id));await L(e,5),le(!1)},[c,W]),ze=r.useCallback(async()=>{de(!0);const e=c.filter(a=>!a.audioUrl).map(a=>()=>q(a.id));await L(e,5),de(!1)},[c,q]),Ke=r.useCallback(async()=>{ce(!0);const e=c.filter(a=>a.selectedImageForVideo&&a.videos.length===0).map(a=>()=>H(a.id));await L(e,5),ce(!1)},[c,H]),Je=r.useCallback(async()=>{ge(!0);const e=c.flatMap(a=>(a.videos||[]).map((o,t)=>({scene:a,video:o,index:t}))).filter(a=>a.video.url&&a.video.mediaGenerationId&&!a.video.upscaledUrl).map(a=>()=>Z(a.scene.id,a.index));await L(e,5),ge(!1)},[c,Z]),We=r.useCallback(()=>{g(e=>e.map(a=>a.images.length>0?{...a,selectedImageForVideo:a.images[0]}:a)),alert("Picked the first available image for each scene as the video base!")},[]),He=r.useCallback(async()=>{const{botToken:e,chatId:a}=xe.getTelegramConfig();if(!e||!a){alert("Please configure Telegram settings first.");return}const o=c.flatMap((t,s)=>t.images.map((i,l)=>({type:"photo",url:i,caption:`Scene ${s+1}: ${t.voiceoverScript}`,fileName:`${String(s+1).padStart(3,"0")}_image_${String(l+1).padStart(2,"0")}.jpg`})));if(o.length===0){alert("No images to send.");return}pe(!0);try{await ve.sendMedia(o),alert("Images sent to Telegram.")}catch(t){h(t instanceof Error?t.message:"Failed to send images.")}finally{pe(!1)}},[c]),Ze=r.useCallback(async()=>{const{botToken:e,chatId:a}=xe.getTelegramConfig();if(!e||!a){alert("Please configure Telegram settings first.");return}const o=c.flatMap((t,s)=>(t.videos||[]).map((i,l)=>({type:"video",url:i.upscaledUrl||i.url,caption:`Scene ${s+1}: ${t.voiceoverScript}`,fileName:`${String(s+1).padStart(3,"0")}_video_${String(l+1).padStart(2,"0")}.mp4`}))).filter(t=>t.url);if(o.length===0){alert("No videos to send.");return}fe(!0);try{await ve.sendMedia(o),alert("Videos sent to Telegram.")}catch(t){h(t instanceof Error?t.message:"Failed to send videos.")}finally{fe(!1)}},[c]);r.useCallback(async()=>{if(V!=="storyboard"){alert("Please generate a storyboard before saving.");return}ue(!0);try{const e=d?{name:d.name,data:await we(d)}:void 0,a=p?{name:p.name,data:await we(p)}:void 0,o={version:"1.1.0-cloner",analysisResult:b,newProductInfo:f,newBigIdea:j,newTargetAudience:U,script:G,scenes:c,newProductImage:e,newReviewerImage:a,videoAspectRatio:I,ttsVoice:D},t=new Blob([JSON.stringify(o,null,2)],{type:"application/json"});ga(t,"cloner-project.vclproj")}catch(e){h(e instanceof Error?e.message:"Failed to save project")}finally{ue(!1)}},[V,b,d,p,f,j,U,G,c,I,D]),r.useCallback(async e=>{var o,t,s;const a=(o=e.target.files)==null?void 0:o[0];if(a){me(!0);try{const i=await a.text(),l=JSON.parse(i);if(!((t=l.version)!=null&&t.includes("-cloner")))throw new Error("Invalid project file.");A(l.analysisResult||null),X(l.newProductInfo||""),_(l.newBigIdea||""),$(l.newTargetAudience||""),z(l.script||""),g(l.scenes||[]),Ve(l.videoAspectRatio||"9:16"),je(l.ttsVoice||"Kore"),l.newProductImage?C(await be(l.newProductImage.data,l.newProductImage.name)):C(null),l.newReviewerImage?O(await be(l.newReviewerImage.data,l.newReviewerImage.name)):O(null),((s=l.scenes)==null?void 0:s.length)>0?m("storyboard"):l.script?m("script"):l.analysisResult?m("input"):m("upload")}catch(i){h(i instanceof Error?i.message:"Failed to import project")}finally{me(!1)}}},[]);const qe=(e,a)=>g(o=>o.map(t=>t.id===e?{...t,imagePrompt:a}:t)),Qe=(e,a)=>g(o=>o.map(t=>t.id===e?{...t,videoPrompt:a}:t)),Xe=(e,a)=>g(o=>o.map(t=>t.id===e?{...t,voiceoverGuide:a}:t)),Ye=(e,a,o)=>g(t=>t.map(s=>s.id===e?{...s,[a]:o}:s)),ea=(e,a)=>g(o=>o.map(t=>t.id!==e?t:{...t,images:t.images.filter(s=>s!==a),selectedImageForVideo:t.selectedImageForVideo===a?void 0:t.selectedImageForVideo})),aa=(e,a)=>g(o=>o.map(t=>t.id===e?{...t,selectedImageForVideo:a,videos:[],videoGenerationError:null}:t)),ta=async(e,a)=>{try{const o=await x(a);g(t=>t.map(s=>s.id===e?{...s,images:[...s.images,o],selectedImageForVideo:o,videos:[],videoGenerationError:null}:s))}catch{h("Failed to process the uploaded image.")}},oa=e=>g(a=>a.map(o=>o.id===e?{...o,shouldUpscaleVideo:!o.shouldUpscaleVideo}:o)),na=e=>{window.confirm("Are you sure you want to delete this scene? This action cannot be undone.")&&g(a=>a.filter(o=>o.id!==e))};return V==="storyboard"?n.jsxs("div",{className:"flex flex-col h-full",children:[n.jsxs("header",{className:"py-4 px-8 bg-gray-800 shadow-lg border-b border-gray-700 shrink-0 flex justify-between items-center",children:[n.jsx("div",{children:n.jsxs("h1",{className:"text-3xl font-bold text-blue-400",children:[n.jsx("i",{className:"fas fa-clone mr-3"}),"Video Ad Cloner - Storyboard"]})}),n.jsx("div",{className:"flex items-center gap-2",children:n.jsxs("button",{onClick:()=>m("script"),className:"text-sm bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-full",children:[n.jsx("i",{className:"fas fa-arrow-left mr-2"})," Back to Script"]})})]}),n.jsx("main",{className:"flex-1 overflow-y-auto p-4 md:p-8",children:n.jsx(ua,{generationStep:"prompts_generated",scenes:c,isLoading:oe,isGeneratingPrompts:!1,error:K,voiceoverScript:G,onVoiceoverScriptChange:()=>{},onGeneratePrompts:()=>{},sceneOverrides:J,onGenerateImage:W,onSceneImagePromptChange:qe,onSceneVideoPromptChange:Qe,onSceneVoiceoverGuideChange:Xe,onSceneEnhancementChange:Ye,onSceneOverrideChange:(e,a,o)=>Ue(t=>({...t,[e]:{...t[e],[a]:o}})),onDeleteImage:ea,onViewImage:se,onUploadImageForVideo:ta,onGenerateAllImages:$e,isBatchGenerating:Ne,onViewStoryboard:()=>ie(!0),onDownloadAllImages:()=>pa(c),isDownloadingImages:!1,onDownloadAllVideos:()=>ma(c),isDownloadingVideos:!1,onSelectImageForVideo:aa,onGenerateVideo:H,onToggleVideoUpscale:oa,onUpscaleVideo:Z,onGenerateAllVideos:Ke,isBatchGeneratingVideos:Ce,onUpscaleAllVideos:Je,isBatchUpscalingVideos:ke,generatedEnvironments:[],onGenerateAudio:q,onGenerateAllAudio:ze,isBatchGeneratingAudio:Ae,activeModule:"video-cloner",onAddScene:_e,onPickAllImages:We,onSendAllImagesToTelegram:He,isSendingImagesToTelegram:Te,onSendAllVideosToTelegram:Ze,isSendingVideosToTelegram:Ee,videoAspectRatio:I,onToggleDialogueInPrompt:()=>{},onGenerateEnhancedPrompt:()=>{},onDeleteScene:na,onDeleteVideo:Oe})}),re&&n.jsx(Sa,{imageUrl:re,onClose:()=>se(null)}),Ge&&n.jsx(fa,{scenes:c,onClose:()=>ie(!1),videoAspectRatio:I})]}):V==="script"?n.jsx("div",{className:"flex flex-col h-full items-center justify-center p-4",children:n.jsxs("div",{className:"w-full max-w-4xl",children:[n.jsx(ha,{script:G,onScriptChange:z,onGenerate:Me,isGenerating:oe}),n.jsx("div",{className:"flex justify-between items-center mt-4",children:n.jsxs("button",{onClick:()=>m("input"),className:"text-sm bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-full",children:[n.jsx("i",{className:"fas fa-arrow-left mr-2"})," Back to Inputs"]})})]})}):V==="input"?n.jsx("div",{className:"flex flex-col h-full items-center p-4 md:p-8 overflow-y-auto",children:n.jsxs("div",{className:"w-full max-w-4xl bg-gray-800 p-6 rounded-2xl border border-gray-700 space-y-6",children:[n.jsx("h1",{className:"text-3xl font-bold text-blue-400",children:"Step 2: Define New Creative"}),n.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[n.jsx(ye,{id:"new-product",label:"New Product Image",file:d,onFileChange:C}),n.jsx(ye,{id:"new-reviewer",label:"New Reviewer/Character (Optional)",file:p,onFileChange:O})]}),n.jsxs("div",{children:[n.jsx("label",{htmlFor:"new-product-info",className:"block text-md font-bold text-blue-400 mb-2",children:"New Product Info"}),n.jsx("textarea",{id:"new-product-info",value:f,onChange:e=>X(e.target.value),rows:4,className:"w-full bg-gray-700 rounded-lg p-3"})]}),n.jsxs("div",{children:[n.jsx("label",{htmlFor:"new-big-idea",className:"block text-md font-bold text-blue-400 mb-2",children:"New Big Idea / Key Message"}),n.jsxs("div",{className:"flex gap-2 items-center",children:[n.jsx("input",{id:"new-big-idea",type:"text",value:j,onChange:e=>_(e.target.value),className:"w-full bg-gray-700 rounded-lg p-3"}),n.jsx("button",{onClick:Be,disabled:Ie||!d||!f,className:"text-xs shrink-0 bg-purple-600 hover:bg-purple-700 rounded-full px-3 py-2 disabled:opacity-50",children:"Suggest"})]})]}),n.jsxs("div",{children:[n.jsx("label",{htmlFor:"new-target-audience",className:"block text-md font-bold text-blue-400 mb-2",children:"New Target Audience"}),n.jsxs("div",{className:"flex gap-2 items-center",children:[n.jsx("input",{id:"new-target-audience",type:"text",value:U,onChange:e=>$(e.target.value),className:"w-full bg-gray-700 rounded-lg p-3"}),n.jsx("button",{onClick:De,disabled:Se||!d||!f,className:"text-xs shrink-0 bg-purple-600 hover:bg-purple-700 rounded-full px-3 py-2 disabled:opacity-50",children:"Suggest"})]})]}),n.jsxs("div",{className:"flex justify-between items-center pt-4 border-t border-gray-700",children:[n.jsxs("button",{onClick:()=>m("upload"),className:"text-sm bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-full",children:[n.jsx("i",{className:"fas fa-arrow-left mr-2"})," Back"]}),n.jsx("button",{onClick:Le,disabled:ae||!j||!d,className:"bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full text-lg disabled:opacity-50",children:ae?"Generating...":"Generate Script"})]})]})}):n.jsx("div",{className:"flex flex-col h-full items-center justify-center p-4",children:n.jsxs("div",{className:"w-full max-w-2xl text-center",children:[n.jsx("h1",{className:"text-3xl font-bold text-blue-400 mb-4",children:"Step 1: Upload Ad to Clone"}),n.jsx("div",{className:"relative w-full aspect-video bg-gray-800 rounded-lg border-2 border-dashed border-gray-600 flex items-center justify-center",children:E?n.jsx("video",{src:E,controls:!0,className:"w-full h-full rounded-lg"}):n.jsx("p",{className:"text-gray-500",children:"Upload a video to begin"})}),n.jsxs("div",{className:"mt-4 flex justify-center items-center gap-4",children:[n.jsxs("label",{htmlFor:"video-upload",className:"cursor-pointer bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-full",children:[n.jsx("i",{className:"fas fa-upload mr-2"})," Choose Video"]}),n.jsx("input",{id:"video-upload",type:"file",accept:"video/*",onChange:Fe,className:"hidden"}),u&&n.jsx("span",{className:"text-gray-400",children:u.name})]}),n.jsx("button",{onClick:Re,disabled:!u||S,className:"mt-6 w-full max-w-md bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-4 rounded-full disabled:opacity-50 text-xl",children:S?"Analyzing Video...":"Analyze & Proceed"}),K&&n.jsx("p",{className:"text-red-400 mt-4",children:K})]})})};export{Da as default};
