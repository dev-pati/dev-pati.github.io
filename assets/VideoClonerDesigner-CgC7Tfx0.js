import{r as s,j as n}from"./index-DX2mtma_.js";import{u as P,U as fe,c as sa,r as B,t as he,s as ra,O as ia,a as la,d as ca,S as da,V as ga}from"./telegramService-DklkJaQq.js";import{n as ua,o as ma,p as pa,q as fa,c as ha,I as va,m as wa,r as ba}from"./lehuyducanhService-BqsWtKXJ.js";import{g as ya,a as xa,u as Sa}from"./mediaService-1p3th5hq.js";import{r as y,i as Ia,f as ve,d as we}from"./media-CDZXYBSY.js";import{I as be}from"./ImageUpload-mUB4HcDX.js";import{s as ye}from"./settingsService-Tte2DU1T.js";const Va=(w,L)=>new Promise((I,p)=>{const u=document.createElement("video");u.preload="metadata",u.src=URL.createObjectURL(w),u.muted=!0;const G=document.createElement("canvas"),T=G.getContext("2d"),E=[];u.onloadedmetadata=()=>{G.width=u.videoWidth,G.height=u.videoHeight;const x=u.duration;if(!x||x===1/0)return URL.revokeObjectURL(u.src),p("Could not determine video duration.");const F=Math.floor(x*L),b=1/L;let A=0,c=0;const U=()=>{if(c>=F||A>x){URL.revokeObjectURL(u.src),I(E);return}u.currentTime=A};u.onseeked=()=>{if(!T)return URL.revokeObjectURL(u.src),p("Canvas context not available");T.drawImage(u,0,0,u.videoWidth,u.videoHeight),E.push(G.toDataURL("image/jpeg",.8)),c++,A+=b,U()},u.onerror=f=>{URL.revokeObjectURL(u.src),p("Error loading or seeking video for frame capture.")},U()},u.onerror=x=>{URL.revokeObjectURL(u.src),p("Error loading video metadata.")}}),Fa=({currentUser:w,onLogout:L})=>{const[I,p]=s.useState("upload"),[u,G]=s.useState(null),[T,E]=s.useState(null),[x,F]=s.useState(!1),[b,A]=s.useState(null),[c,U]=s.useState(null),[f,O]=s.useState(null),[h,Q]=s.useState(""),[V,M]=s.useState(""),[j,_]=s.useState(""),[xe,X]=s.useState(!1),[Se,Y]=s.useState(!1),[S,Ie]=s.useState("9:16"),[N,$]=s.useState(""),[ee,ae]=s.useState(!1),[d,g]=s.useState([]),[te,oe]=s.useState(!1),[z,v]=s.useState(null),[R,Ve]=s.useState("Kore"),[K,je]=s.useState({}),[ne,se]=s.useState(null),[Ne,re]=s.useState(!1),[Ge,ie]=s.useState(!1),[Ae,le]=s.useState(!1),[Ue,ce]=s.useState(!1),[Ce,de]=s.useState(!1),[ja,ge]=s.useState(!1),[Na,ue]=s.useState(!1),[ke,me]=s.useState(!1),[Te,pe]=s.useState(!1),[Ga,Pe]=s.useState({storyboard:0,image:0,video:0}),C=s.useCallback(()=>{if(w){const e=P.getUsage(w);Pe({storyboard:e.generateStoryboard.count,image:e.generateImage.count,video:e.generateVideo.count})}},[w]);s.useEffect(()=>{C()},[w,C]);const Ee=e=>{var o;const a=(o=e.target.files)==null?void 0:o[0];a&&a.type.startsWith("video/")?(G(a),E(URL.createObjectURL(a)),v(null)):v("Please upload a valid video file.")},Fe=async()=>{if(u){F(!0),v(null);try{const a=await Va(u,2),o=a.length/2,t=await ba(a,2,o);A(t),p("input")}catch(e){v(e instanceof Error?e.message:"An unknown error occurred during video analysis.")}finally{F(!1)}}},Re=s.useCallback(async()=>{if(!(!c||!h)){X(!0);try{const e=await y(c),a=await ua(h,e);_(a)}catch(e){v(e instanceof Error?e.message:"Failed to suggest target audience.")}finally{X(!1)}}},[c,h]),De=s.useCallback(async()=>{if(!(!c||!h)){Y(!0);try{const e=await y(c),a=await ma(h,e);M(a)}catch(e){v(e instanceof Error?e.message:"Failed to suggest key message.")}finally{Y(!1)}}},[c,h]),Be=s.useCallback(async()=>{if(!(!b||!c||!V)){ae(!0),v(null);try{const e=await y(c),a=f?await y(f):void 0,o=await pa(b,V,e,h,j,a);$(o),p("script")}catch(e){v(e instanceof Error?e.message:"Failed to generate cloned script.")}finally{ae(!1)}}},[b,V,c,h,j,f]),Le=s.useCallback(async()=>{if(!(!b||!N||!c)){oe(!0),v(null);try{const e=await y(c),a=f?await y(f):void 0,o=await fa(b,N,e,h,j,a);g(o),p("storyboard")}catch(e){v(e instanceof Error?e.message:"Failed to generate storyboard.")}finally{oe(!1)}}},[b,N,c,h,j,f]),J=s.useCallback(async e=>{if(!P.canPerformAction(w,"generateImage"))throw new Error(`Daily image generation limit of ${fe.generateImage} reached.`);const a=d.find(o=>o.id===e);if(a){g(o=>o.map(t=>t.id===e?{...t,isGeneratingImage:!0,imageGenerationError:null}:t));try{const t=(K[e]||{}).imageProvider||"lehuyducanh",r=[];c&&r.push(await y(c)),f&&r.push(await y(f));const l=await ya({provider:t,prompt:a.imagePrompt,subjectUrls:r,aspectRatio:S});g(i=>i.map(m=>m.id===e?{...m,images:[...m.images,...l],isGeneratingImage:!1}:m)),P.logAction(w,"generateImage"),C()}catch(o){const t=o instanceof Error?o.message:"Unknown image generation error.";throw g(r=>r.map(l=>l.id===e?{...l,isGeneratingImage:!1,imageGenerationError:t}:l)),o}}},[d,K,c,f,S,w,C]),Oe=(e,a)=>{g(o=>o.map(t=>{if(t.id!==e)return t;const r=[...t.videos];return r.splice(a,1),{...t,videos:r}}))},W=s.useCallback(async e=>{if(!P.canPerformAction(w,"generateVideo"))throw new Error(`Daily video generation limit of ${fe.generateVideo} reached.`);const a=d.find(o=>o.id===e);if(!a||!a.selectedImageForVideo)throw new Error("No image selected for video generation.");g(o=>o.map(t=>t.id===e?{...t,isGeneratingVideo:!0,videoGenerationError:null}:t));try{const o=await Ia(a.selectedImageForVideo),t=`{
  "voiceover": ${JSON.stringify(a.voiceoverScript)},
  "motion_action": ${JSON.stringify(a.videoPrompt)},
  "audio": {
    "background_music": "none",
    "allow_music": false,
    "allow_sound_effects": true,
    "allow_voiceover": true,
    "policy": "no_music_background_only_sfx_and_voice"
  }
}`,{videoUrl:r,upscaledUrl:l,mediaGenerationId:i,seed:m}=await xa({provider:"lehuyducanh",prompt:t,imageUrl:o,upscale:a.shouldUpscaleVideo,aspectRatio:S}),k={url:r,mediaGenerationId:i,seed:m,upscaledUrl:l};g(q=>q.map(D=>{if(D.id!==e)return D;const na=[...D.videos,k];return{...D,videos:na,isGeneratingVideo:!1}})),P.logAction(w,"generateVideo"),C()}catch(o){const t=o instanceof Error?o.message:"An unknown error occurred.";throw g(r=>r.map(l=>l.id===e?{...l,isGeneratingVideo:!1,videoGenerationError:t}:l)),o}},[d,w,C,S]),H=s.useCallback(async(e,a)=>{const o=d.find(r=>r.id===e),t=o==null?void 0:o.videos[a];if(t){g(r=>r.map(l=>l.id===e?{...l,videos:l.videos.map((i,m)=>m===a?{...i,isUpscaling:!0,upscaleError:null}:i)}:l));try{const r=await Sa({provider:"lehuyducanh",mediaGenerationId:t.mediaGenerationId,seed:t.seed});g(l=>l.map(i=>i.id===e?{...i,videos:i.videos.map((m,k)=>k===a?{...m,upscaledUrl:r,isUpscaling:!1}:m)}:i))}catch(r){const l=r instanceof Error?r.message:"An unknown error occurred during upscale.";throw g(i=>i.map(m=>m.id===e?{...m,videos:m.videos.map((k,q)=>q===a?{...k,isUpscaling:!1,upscaleError:l}:k)}:m)),r}}},[d]),Z=s.useCallback(async e=>{const a=d.find(o=>o.id===e);if(a){g(o=>o.map(t=>t.id===e?{...t,isGeneratingAudio:!0,audioGenerationError:null}:t));try{const o=await ha(a.voiceoverScript,a.voiceoverGuide,R),t=sa(o),r=URL.createObjectURL(t);g(l=>l.map(i=>i.id===e?{...i,audioUrl:r,isGeneratingAudio:!1}:i))}catch(o){const t=o instanceof Error?o.message:"An unknown audio generation error occurred.";g(r=>r.map(l=>l.id===e?{...l,isGeneratingAudio:!1,audioGenerationError:t}:l))}}},[d,R]),Me=e=>{const a=wa({voiceoverScript:"New scene"});g(o=>{const t=[...o];return t.splice(e,0,a),t})},_e=s.useCallback(async()=>{ie(!0);const e=d.filter(a=>a.images.length===0).map(a=>()=>J(a.id));await B(e,5),ie(!1)},[d,J]),$e=s.useCallback(async()=>{le(!0);const e=d.filter(a=>!a.audioUrl).map(a=>()=>Z(a.id));await B(e,5),le(!1)},[d,Z]),ze=s.useCallback(async()=>{ce(!0);const e=d.filter(a=>a.selectedImageForVideo&&a.videos.length===0).map(a=>()=>W(a.id));await B(e,5),ce(!1)},[d,W]),Ke=s.useCallback(async()=>{de(!0);const e=d.flatMap(a=>(a.videos||[]).map((o,t)=>({scene:a,video:o,index:t}))).filter(a=>a.video.url&&a.video.mediaGenerationId&&!a.video.upscaledUrl).map(a=>()=>H(a.scene.id,a.index));await B(e,5),de(!1)},[d,H]),Je=s.useCallback(()=>{g(e=>e.map(a=>a.images.length>0?{...a,selectedImageForVideo:a.images[0]}:a)),alert("Picked the first available image for each scene as the video base!")},[]),We=s.useCallback(async()=>{const{botToken:e,chatId:a}=ye.getTelegramConfig();if(!e||!a){alert("Please configure Telegram settings first.");return}const o=d.flatMap((t,r)=>t.images.map((l,i)=>({type:"photo",url:l,caption:`Scene ${r+1}: ${t.voiceoverScript}`,fileName:`${String(r+1).padStart(3,"0")}_image_${String(i+1).padStart(2,"0")}.jpg`})));if(o.length===0){alert("No images to send.");return}me(!0);try{await he.sendMedia(o),alert("Images sent to Telegram.")}catch(t){v(t instanceof Error?t.message:"Failed to send images.")}finally{me(!1)}},[d]),He=s.useCallback(async()=>{const{botToken:e,chatId:a}=ye.getTelegramConfig();if(!e||!a){alert("Please configure Telegram settings first.");return}const o=d.flatMap((t,r)=>(t.videos||[]).map((l,i)=>({type:"video",url:l.upscaledUrl||l.url,caption:`Scene ${r+1}: ${t.voiceoverScript}`,fileName:`${String(r+1).padStart(3,"0")}_video_${String(i+1).padStart(2,"0")}.mp4`}))).filter(t=>t.url);if(o.length===0){alert("No videos to send.");return}pe(!0);try{await he.sendMedia(o),alert("Videos sent to Telegram.")}catch(t){v(t instanceof Error?t.message:"Failed to send videos.")}finally{pe(!1)}},[d]);s.useCallback(async()=>{if(I!=="storyboard"){alert("Please generate a storyboard before saving.");return}ge(!0);try{const e=c?{name:c.name,data:await ve(c)}:void 0,a=f?{name:f.name,data:await ve(f)}:void 0,o={version:"1.1.0-cloner",analysisResult:b,newProductInfo:h,newBigIdea:V,newTargetAudience:j,script:N,scenes:d,newProductImage:e,newReviewerImage:a,videoAspectRatio:S,ttsVoice:R},t=new Blob([JSON.stringify(o,null,2)],{type:"application/json"});ra(t,"cloner-project.vclproj")}catch(e){v(e instanceof Error?e.message:"Failed to save project")}finally{ge(!1)}},[I,b,c,f,h,V,j,N,d,S,R]),s.useCallback(async e=>{var o,t,r;const a=(o=e.target.files)==null?void 0:o[0];if(a){ue(!0);try{const l=await a.text(),i=JSON.parse(l);if(!((t=i.version)!=null&&t.includes("-cloner")))throw new Error("Invalid project file.");A(i.analysisResult||null),Q(i.newProductInfo||""),M(i.newBigIdea||""),_(i.newTargetAudience||""),$(i.script||""),g(i.scenes||[]),Ie(i.videoAspectRatio||"9:16"),Ve(i.ttsVoice||"Kore"),i.newProductImage?U(await we(i.newProductImage.data,i.newProductImage.name)):U(null),i.newReviewerImage?O(await we(i.newReviewerImage.data,i.newReviewerImage.name)):O(null),((r=i.scenes)==null?void 0:r.length)>0?p("storyboard"):i.script?p("script"):i.analysisResult?p("input"):p("upload")}catch(l){v(l instanceof Error?l.message:"Failed to import project")}finally{ue(!1)}}},[]);const Ze=(e,a)=>g(o=>o.map(t=>t.id===e?{...t,imagePrompt:a}:t)),qe=(e,a)=>g(o=>o.map(t=>t.id===e?{...t,videoPrompt:a}:t)),Qe=(e,a)=>g(o=>o.map(t=>t.id===e?{...t,voiceoverGuide:a}:t)),Xe=(e,a,o)=>g(t=>t.map(r=>r.id===e?{...r,[a]:o}:r)),Ye=(e,a)=>g(o=>o.map(t=>t.id!==e?t:{...t,images:t.images.filter(r=>r!==a),selectedImageForVideo:t.selectedImageForVideo===a?void 0:t.selectedImageForVideo})),ea=(e,a)=>g(o=>o.map(t=>t.id===e?{...t,selectedImageForVideo:a,videos:[],videoGenerationError:null}:t)),aa=async(e,a)=>{try{const o=await y(a);g(t=>t.map(r=>r.id===e?{...r,images:[...r.images,o],selectedImageForVideo:o,videos:[],videoGenerationError:null}:r))}catch{v("Failed to process the uploaded image.")}},ta=e=>g(a=>a.map(o=>o.id===e?{...o,shouldUpscaleVideo:!o.shouldUpscaleVideo}:o)),oa=e=>{window.confirm("Are you sure you want to delete this scene? This action cannot be undone.")&&g(a=>a.filter(o=>o.id!==e))};return I==="storyboard"?n.jsxs("div",{className:"flex flex-col h-full",children:[n.jsxs("header",{className:"py-4 px-8 bg-gray-800 shadow-lg border-b border-gray-700 shrink-0 flex justify-between items-center",children:[n.jsx("div",{children:n.jsxs("h1",{className:"text-3xl font-bold text-blue-400",children:[n.jsx("i",{className:"fas fa-clone mr-3"}),"Video Ad Cloner - Storyboard"]})}),n.jsx("div",{className:"flex items-center gap-2",children:n.jsxs("button",{onClick:()=>p("script"),className:"text-sm bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-full",children:[n.jsx("i",{className:"fas fa-arrow-left mr-2"})," Back to Script"]})})]}),n.jsx("main",{className:"flex-1 overflow-y-auto p-4 md:p-8",children:n.jsx(ia,{generationStep:"prompts_generated",scenes:d,isLoading:te,isGeneratingPrompts:!1,error:z,voiceoverScript:N,onVoiceoverScriptChange:()=>{},onGeneratePrompts:()=>{},sceneOverrides:K,onGenerateImage:J,onSceneImagePromptChange:Ze,onSceneVideoPromptChange:qe,onSceneVoiceoverGuideChange:Qe,onSceneEnhancementChange:Xe,onSceneOverrideChange:(e,a,o)=>je(t=>({...t,[e]:{...t[e],[a]:o}})),onDeleteImage:Ye,onViewImage:se,onUploadImageForVideo:aa,onGenerateAllImages:_e,isBatchGenerating:Ge,onViewStoryboard:()=>re(!0),onDownloadAllImages:()=>ca(d),isDownloadingImages:!1,onDownloadAllVideos:()=>la(d),isDownloadingVideos:!1,onSelectImageForVideo:ea,onGenerateVideo:W,onToggleVideoUpscale:ta,onUpscaleVideo:H,onGenerateAllVideos:ze,isBatchGeneratingVideos:Ue,onUpscaleAllVideos:Ke,isBatchUpscalingVideos:Ce,generatedEnvironments:[],onGenerateAudio:Z,onGenerateAllAudio:$e,isBatchGeneratingAudio:Ae,activeModule:"video-cloner",onAddScene:Me,onPickAllImages:Je,onSendAllImagesToTelegram:We,isSendingImagesToTelegram:ke,onSendAllVideosToTelegram:He,isSendingVideosToTelegram:Te,videoAspectRatio:S,onToggleDialogueInPrompt:()=>{},onGenerateEnhancedPrompt:()=>{},onDeleteScene:oa,onDeleteVideo:Oe})}),ne&&n.jsx(va,{imageUrl:ne,onClose:()=>se(null)}),Ne&&n.jsx(da,{scenes:d,onClose:()=>re(!1),videoAspectRatio:S})]}):I==="script"?n.jsx("div",{className:"flex flex-col h-full items-center justify-center p-4",children:n.jsxs("div",{className:"w-full max-w-4xl",children:[n.jsx(ga,{script:N,onScriptChange:$,onGenerate:Le,isGenerating:te}),n.jsx("div",{className:"flex justify-between items-center mt-4",children:n.jsxs("button",{onClick:()=>p("input"),className:"text-sm bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-full",children:[n.jsx("i",{className:"fas fa-arrow-left mr-2"})," Back to Inputs"]})})]})}):I==="input"?n.jsx("div",{className:"flex flex-col h-full items-center p-4 md:p-8 overflow-y-auto",children:n.jsxs("div",{className:"w-full max-w-4xl bg-gray-800 p-6 rounded-2xl border border-gray-700 space-y-6",children:[n.jsx("h1",{className:"text-3xl font-bold text-blue-400",children:"Step 2: Define New Creative"}),n.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[n.jsx(be,{id:"new-product",label:"New Product Image",file:c,onFileChange:U}),n.jsx(be,{id:"new-reviewer",label:"New Reviewer/Character (Optional)",file:f,onFileChange:O})]}),n.jsxs("div",{children:[n.jsx("label",{htmlFor:"new-product-info",className:"block text-md font-bold text-blue-400 mb-2",children:"New Product Info"}),n.jsx("textarea",{id:"new-product-info",value:h,onChange:e=>Q(e.target.value),rows:4,className:"w-full bg-gray-700 rounded-lg p-3"})]}),n.jsxs("div",{children:[n.jsx("label",{htmlFor:"new-big-idea",className:"block text-md font-bold text-blue-400 mb-2",children:"New Big Idea / Key Message"}),n.jsxs("div",{className:"flex gap-2 items-center",children:[n.jsx("input",{id:"new-big-idea",type:"text",value:V,onChange:e=>M(e.target.value),className:"w-full bg-gray-700 rounded-lg p-3"}),n.jsx("button",{onClick:De,disabled:Se||!c||!h,className:"text-xs shrink-0 bg-purple-600 hover:bg-purple-700 rounded-full px-3 py-2 disabled:opacity-50",children:"Suggest"})]})]}),n.jsxs("div",{children:[n.jsx("label",{htmlFor:"new-target-audience",className:"block text-md font-bold text-blue-400 mb-2",children:"New Target Audience"}),n.jsxs("div",{className:"flex gap-2 items-center",children:[n.jsx("input",{id:"new-target-audience",type:"text",value:j,onChange:e=>_(e.target.value),className:"w-full bg-gray-700 rounded-lg p-3"}),n.jsx("button",{onClick:Re,disabled:xe||!c||!h,className:"text-xs shrink-0 bg-purple-600 hover:bg-purple-700 rounded-full px-3 py-2 disabled:opacity-50",children:"Suggest"})]})]}),n.jsxs("div",{className:"flex justify-between items-center pt-4 border-t border-gray-700",children:[n.jsxs("button",{onClick:()=>p("upload"),className:"text-sm bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-full",children:[n.jsx("i",{className:"fas fa-arrow-left mr-2"})," Back"]}),n.jsx("button",{onClick:Be,disabled:ee||!V||!c,className:"bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full text-lg disabled:opacity-50",children:ee?"Generating...":"Generate Script"})]})]})}):n.jsx("div",{className:"flex flex-col h-full items-center justify-center p-4",children:n.jsxs("div",{className:"w-full max-w-2xl text-center",children:[n.jsx("h1",{className:"text-3xl font-bold text-blue-400 mb-4",children:"Step 1: Upload Ad to Clone"}),n.jsx("div",{className:"relative w-full aspect-video bg-gray-800 rounded-lg border-2 border-dashed border-gray-600 flex items-center justify-center",children:T?n.jsx("video",{src:T,controls:!0,className:"w-full h-full rounded-lg"}):n.jsx("p",{className:"text-gray-500",children:"Upload a video to begin"})}),n.jsxs("div",{className:"mt-4 flex justify-center items-center gap-4",children:[n.jsxs("label",{htmlFor:"video-upload",className:"cursor-pointer bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-full",children:[n.jsx("i",{className:"fas fa-upload mr-2"})," Choose Video"]}),n.jsx("input",{id:"video-upload",type:"file",accept:"video/*",onChange:Ee,className:"hidden"}),u&&n.jsx("span",{className:"text-gray-400",children:u.name})]}),n.jsx("button",{onClick:Fe,disabled:!u||x,className:"mt-6 w-full max-w-md bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-4 rounded-full disabled:opacity-50 text-xl",children:x?"Analyzing Video...":"Analyze & Proceed"}),z&&n.jsx("p",{className:"text-red-400 mt-4",children:z})]})})};export{Fa as default};
