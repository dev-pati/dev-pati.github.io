import{j as r,r as i}from"./index-DX2mtma_.js";import{A as De}from"./config-PJqXRuVJ.js";import{u as S,U,c as Me,r as I,t as ee,s as $e,O as Be,a as Oe,d as Re,S as Le}from"./telegramService-DklkJaQq.js";import{s as _e,c as Ke,m as ae,I as Ze}from"./lehuyducanhService-BqsWtKXJ.js";import{g as Je,u as ze,a as Qe}from"./mediaService-1p3th5hq.js";import{r as te,i as We}from"./media-CDZXYBSY.js";import{s as oe}from"./settingsService-Tte2DU1T.js";const Ye=[{value:"Kore",label:"Kore (Female)"},{value:"Puck",label:"Puck (Male)"},{value:"Charon",label:"Charon (Male)"},{value:"Fenrir",label:"Fenrir (Male)"},{value:"Zephyr",label:"Zephyr (Male)"}],qe=({script:g,setScript:D,visualStyle:h,setVisualStyle:j,onGenerate:b,isGenerating:V,videoAspectRatio:c,setVideoAspectRatio:l,ttsVoice:N,setTtsVoice:p})=>r.jsxs("div",{className:"bg-gray-800 p-6 rounded-2xl border border-gray-700 shadow-lg flex flex-col gap-6",children:[r.jsxs("h3",{className:"text-xl font-bold text-blue-400 -mb-2",children:[r.jsx("i",{className:"fas fa-file-alt mr-2"}),"Explainer Content"]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"explainer-script",className:"block text-md font-bold text-blue-400 mb-2",children:"Script or Topic"}),r.jsx("textarea",{id:"explainer-script",value:g,onChange:u=>D(u.target.value),placeholder:"Paste your full explainer script here...",className:"w-full bg-gray-700 border-2 border-gray-600 rounded-lg p-3 text-gray-200 focus:ring-2 focus:ring-blue-500 transition duration-200",rows:12})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"visual-style",className:"block text-md font-bold text-blue-400 mb-2",children:"Global Visual Style"}),r.jsx("input",{id:"visual-style",type:"text",value:h,onChange:u=>j(u.target.value),placeholder:"e.g., minimalist 2D animation, claymation style, photorealistic stock footage",className:"w-full bg-gray-700 border-2 border-gray-600 rounded-lg p-3 text-gray-200 focus:ring-2 focus:ring-blue-500 transition duration-200"})]}),r.jsx("div",{className:"border-t-2 border-gray-700 -mx-6"}),r.jsxs("div",{className:"space-y-4",children:[r.jsxs("h3",{className:"text-lg font-bold text-blue-400 mb-2",children:[r.jsx("i",{className:"fas fa-cog mr-2"}),"Audio & Video Settings"]}),r.jsxs("div",{children:[r.jsxs("label",{htmlFor:"aspect-ratio-explainer",className:"block text-md font-bold text-blue-400 mb-2",children:[r.jsx("i",{className:"fas fa-ruler-combined mr-2"}),"Video Aspect Ratio"]}),r.jsxs("select",{id:"aspect-ratio-explainer",value:c,onChange:u=>l(u.target.value),className:"w-full bg-gray-700 border-2 border-gray-600 rounded-lg p-3 text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200",children:[r.jsx("option",{value:"16:9",children:"16:9 (Landscape)"}),r.jsx("option",{value:"9:16",children:"9:16 (Portrait)"})]})]}),r.jsxs("div",{children:[r.jsx("label",{htmlFor:"tts-voice-explainer",className:"block text-md font-bold text-blue-400 mb-2",children:"Voiceover Model"}),r.jsx("select",{id:"tts-voice-explainer",value:N,onChange:u=>p(u.target.value),className:"w-full bg-gray-700 border-2 border-gray-600 rounded-lg p-3 text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200",children:Ye.map(u=>r.jsx("option",{value:u.value,children:u.label},u.value))})]})]}),r.jsx("div",{className:"border-t-2 border-gray-700 -mx-6 pt-6",children:r.jsx("button",{onClick:b,disabled:V||!g||!h,className:"w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-full disabled:opacity-50 disabled:cursor-not-allowed transition-all text-lg flex items-center justify-center gap-2",title:!g||!h?"Please provide a script and visual style":"Generate Storyboard",children:V?r.jsxs(r.Fragment,{children:[r.jsx("i",{className:"fas fa-spinner fa-spin"}),"Generating Storyboard..."]}):r.jsxs(r.Fragment,{children:[r.jsx("i",{className:"fas fa-wand-magic-sparkles"}),"Generate Storyboard"]})})})]}),sa=({currentUser:g,onLogout:D})=>{const[h,j]=i.useState(""),[b,V]=i.useState(""),[c,l]=i.useState([]),[N,p]=i.useState(null),[u,M]=i.useState(!1),[w,$]=i.useState("Kore"),[v,B]=i.useState("16:9"),[G,O]=i.useState({}),[R,L]=i.useState(null),[re,_]=i.useState(!1),[ne,K]=i.useState(!1),[se,Z]=i.useState(!1),[ie,J]=i.useState(!1),[le,z]=i.useState(!1),[Q,W]=i.useState(!1),[k,Y]=i.useState(!1),[ce,q]=i.useState(!1),[de,H]=i.useState(!1),[He,ge]=i.useState({storyboard:0,image:0,video:0}),x=i.useCallback(()=>{if(g){const o=S.getUsage(g);ge({storyboard:o.generateStoryboard.count,image:o.generateImage.count,video:o.generateVideo.count})}},[g]);i.useEffect(()=>{x()},[g,x]);const X=i.useCallback(async()=>{if(!S.canPerformAction(g,"generateStoryboard")){alert(`Daily limit of ${U.generateStoryboard} storyboard generations reached.`);return}if(!h||!b){p("Please provide a script/topic and a visual style.");return}M(!0),p(null),l([]);try{const o=await _e(h,b);l(o),S.logAction(g,"generateStoryboard"),x()}catch(o){p(o instanceof Error?o.message:"An unknown error occurred.")}finally{M(!1)}},[h,b,g,x]),E=i.useCallback(async o=>{if(!S.canPerformAction(g,"generateImage"))throw new Error(`Daily image generation limit of ${U.generateImage} reached.`);const t=c.find(a=>a.id===o);if(t){l(a=>a.map(e=>e.id===o?{...e,isGeneratingImage:!0,imageGenerationError:null}:e));try{const a=G[o]||{},e=a.imageProvider||"lehuyducanh",n=a.referenceImages||[],s=await Promise.all(n.map(f=>te(f))),d=`${t.imagePrompt}, in the style of ${b}`,m=await Je({provider:e,prompt:d,referenceUrls:s,aspectRatio:v});l(f=>f.map(y=>y.id===o?{...y,images:[...y.images,...m],isGeneratingImage:!1}:y)),S.logAction(g,"generateImage"),x()}catch(a){const e=a instanceof Error?a.message:"Unknown image generation error.";throw l(n=>n.map(s=>s.id===o?{...s,isGeneratingImage:!1,imageGenerationError:e}:s)),a}}},[c,G,g,x,b,v]),me=o=>{const t=ae({voiceoverScript:"New scene",voiceoverGuide:"Neutral tone",imagePrompt:"",videoPrompt:""});l(a=>{const e=[...a];return e.splice(o,0,t),e})},C=i.useCallback(async o=>{const t=c.find(a=>a.id===o);if(t){l(a=>a.map(e=>e.id===o?{...e,isGeneratingAudio:!0,audioGenerationError:null}:e));try{const a=await Ke(t.voiceoverScript,t.voiceoverGuide,w),e=Me(a),n=URL.createObjectURL(e);l(s=>s.map(d=>d.id===o?{...d,audioUrl:n,isGeneratingAudio:!1}:d))}catch(a){const e=a instanceof Error?a.message:"An unknown audio generation error occurred.";l(n=>n.map(s=>s.id===o?{...s,isGeneratingAudio:!1,audioGenerationError:e}:s))}}},[c,w]),pe=i.useCallback(async()=>{const o=c.filter(a=>!a.audioUrl);if(o.length===0){alert("All scenes already have generated audio.");return}K(!0);const t=o.map(a=>()=>C(a.id));await I(t,5),K(!1)},[c,C]),P=i.useCallback(async(o,t)=>{const a=c.find(n=>n.id===o),e=a==null?void 0:a.videos[t];if(!e){console.error("handleUpscaleVideo could not find the video in state:",o,t);return}l(n=>n.map(s=>s.id===o?{...s,videos:s.videos.map((d,m)=>m===t?{...d,isUpscaling:!0,upscaleError:null}:d)}:s));try{const n=await ze({provider:"lehuyducanh",mediaGenerationId:e.mediaGenerationId,seed:e.seed});l(s=>s.map(d=>d.id===o?{...d,videos:d.videos.map((m,f)=>f===t?{...m,upscaledUrl:n,isUpscaling:!1}:m)}:d))}catch(n){const s=n instanceof Error?n.message:"An unknown error occurred during upscale.";throw l(d=>d.map(m=>m.id===o?{...m,videos:m.videos.map((f,y)=>y===t?{...f,isUpscaling:!1,upscaleError:s}:f)}:m)),n}},[c]),ue=(o,t)=>{l(a=>a.map(e=>{if(e.id!==o)return e;const n=[...e.videos];return n.splice(t,1),{...e,videos:n}}))},T=i.useCallback(async o=>{if(!S.canPerformAction(g,"generateVideo")){const a=`You have reached your daily limit of ${U.generateVideo} video generations.`;throw l(e=>e.map(n=>n.id===o?{...n,isGeneratingVideo:!1,videoGenerationError:a}:n)),new Error(a)}const t=c.find(a=>a.id===o);if(!t||!t.selectedImageForVideo){const a="Attempted to generate video without a selected image.";throw l(e=>e.map(n=>n.id===o?{...n,isGeneratingVideo:!1,videoGenerationError:a}:n)),new Error(a)}l(a=>a.map(e=>e.id===o?{...e,isGeneratingVideo:!0,videoGenerationError:null}:e));try{const a=await We(t.selectedImageForVideo);let e=`Global Visual Style: ${b}.

Voiceover: "${t.voiceoverScript}".

Motion/Action: ${t.videoPrompt}

No Music Background`;const{videoUrl:n,upscaledUrl:s,mediaGenerationId:d,seed:m}=await Qe({provider:"lehuyducanh",prompt:e,imageUrl:a,upscale:t.shouldUpscaleVideo,aspectRatio:v}),f={url:n,mediaGenerationId:d,seed:m,upscaledUrl:s};l(y=>y.map(A=>{if(A.id!==o)return A;const Ue=[...A.videos||[],f];return{...A,videos:Ue,isGeneratingVideo:!1}})),S.logAction(g,"generateVideo"),x()}catch(a){if(!(a instanceof Error&&a.message.includes("daily limit"))){const e=a instanceof Error?a.message:"An unknown error occurred.";l(n=>n.map(s=>s.id===o?{...s,isGeneratingVideo:!1,videoGenerationError:e}:s))}throw a}},[c,g,x,b,v]),fe=i.useCallback(()=>{l(o=>o.map(t=>t.images.length>0?{...t,selectedImageForVideo:t.images[0]}:t)),alert("Picked the first available image for each scene as the video base!")},[]),he=i.useCallback(async()=>{_(!0);const o=c.filter(t=>t.images.length===0).map(t=>()=>E(t.id));await I(o,5),_(!1)},[c,E]),be=i.useCallback(async()=>{Z(!0);const o=c.filter(t=>t.selectedImageForVideo&&(!t.videos||t.videos.length===0)).map(t=>()=>T(t.id));await I(o,5),Z(!1)},[c,T]),ve=i.useCallback(async()=>{J(!0);const o=c.flatMap(t=>(t.videos||[]).map((a,e)=>({scene:t,video:a,index:e}))).filter(t=>t.video.url&&t.video.mediaGenerationId&&!t.video.upscaledUrl).map(t=>()=>P(t.scene.id,t.index));await I(o,5),J(!1)},[c,P]),xe=i.useCallback(async()=>{const{botToken:o,chatId:t}=oe.getTelegramConfig();if(!o||!t){alert("Please configure Telegram settings first in the Settings page.");return}const a=c.flatMap((e,n)=>e.images.map((s,d)=>({type:"photo",url:s,caption:`Scene ${n+1}: ${e.voiceoverScript}`,fileName:`${String(n+1).padStart(3,"0")}_image_${String(d+1).padStart(2,"0")}.jpg`})));if(a.length===0){alert("No generated images found to send.");return}q(!0),p(null);try{await ee.sendMedia(a),alert("All images sent to Telegram successfully!")}catch(e){const n=e instanceof Error?e.message:"Failed to send images to Telegram.";p(n),alert(n)}finally{q(!1)}},[c]),ye=i.useCallback(async()=>{const{botToken:o,chatId:t}=oe.getTelegramConfig();if(!o||!t){alert("Please configure Telegram settings first in the Settings page.");return}const a=c.flatMap((e,n)=>(e.videos||[]).map((s,d)=>({type:"video",url:s.upscaledUrl||s.url,caption:`Scene ${n+1}: ${e.voiceoverScript}`,fileName:`${String(n+1).padStart(3,"0")}_video_${String(d+1).padStart(2,"0")}.mp4`}))).filter(e=>e.url);if(a.length===0){alert("No videos found to send.");return}H(!0),p(null);try{await ee.sendMedia(a),alert("All videos sent to Telegram successfully!")}catch(e){const n=e instanceof Error?e.message:"Failed to send videos to Telegram.";p(n),alert(n)}finally{H(!1)}},[c]),F=c.length>0,Se=i.useCallback(async()=>{if(!F){alert("Please generate a storyboard before saving.");return}W(!0),p(null);try{const t=JSON.stringify({version:"1.2.0-explainer",script:h,visualStyle:b,scenes:c,sceneOverrides:G,ttsVoice:w,videoAspectRatio:v},null,2),a=new Blob([t],{type:"application/json"}),e=(h.substring(0,20).trim().replace(/[\s/]+/g,"-")||"explainer-project").toLowerCase();$e(a,`${e}.evdproj`)}catch(o){const t=o instanceof Error?o.message:"An unknown error occurred during saving.";p(t),alert(`Failed to save project: ${t}`)}finally{W(!1)}},[c,h,b,G,w,F,v]),je=i.useCallback(async o=>{var a,e;const t=(a=o.target.files)==null?void 0:a[0];if(t){Y(!0),p(null);try{const n=await t.text(),s=JSON.parse(n);if(!((e=s.version)!=null&&e.includes("-explainer")))throw new Error("Invalid or incompatible project file. Please import a .evdproj file.");j(s.script||""),V(s.visualStyle||""),$(s.ttsVoice||"Kore"),O(s.sceneOverrides||{}),B(s.videoAspectRatio||"16:9");const m=(s.scenes||[]).map(f=>({...ae({}),...f,videos:f.videos||[]}));l(m),alert("Project imported successfully!")}catch(n){const s=n instanceof Error?n.message:"An unknown error occurred during import.";p(s),alert(`Failed to import project: ${s}`)}finally{Y(!1)}}},[]),Ve=o=>{window.confirm("Are you sure you want to delete this scene? This action cannot be undone.")&&l(t=>t.filter(a=>a.id!==o))},we=(o,t)=>{l(a=>a.map(e=>e.id===o?{...e,includeDialogueInPrompt:t}:e))},Ge=i.useCallback(async(o,t)=>{alert("Enhanced prompt generation is coming soon for Explainer videos!")},[]),Ae=(o,t,a)=>O(e=>({...e,[o]:{...e[o],[t]:a}})),Ie=(o,t)=>l(a=>a.map(e=>e.id===o?{...e,imagePrompt:t}:e)),Ne=(o,t)=>l(a=>a.map(e=>e.id===o?{...e,videoPrompt:t}:e)),ke=(o,t)=>l(a=>a.map(e=>e.id===o?{...e,voiceoverGuide:t}:e)),Ee=(o,t,a)=>l(e=>e.map(n=>n.id===o?{...n,[t]:a}:n)),Ce=(o,t)=>l(a=>a.map(e=>e.id!==o?e:{...e,images:e.images.filter(n=>n!==t),selectedImageForVideo:e.selectedImageForVideo===t?void 0:e.selectedImageForVideo})),Pe=(o,t)=>l(a=>a.map(e=>e.id===o?{...e,selectedImageForVideo:t,videos:[],videoGenerationError:null}:e)),Te=async(o,t)=>{try{const a=await te(t);l(e=>e.map(n=>n.id===o?{...n,images:[...n.images,a],selectedImageForVideo:a,videos:[],videoGenerationError:null}:n))}catch{p("Failed to process the uploaded image.")}},Fe=o=>l(t=>t.map(a=>a.id===o?{...a,shouldUpscaleVideo:!a.shouldUpscaleVideo}:a));return r.jsxs(r.Fragment,{children:[r.jsxs("header",{className:"py-4 px-8 bg-gray-800 shadow-lg border-b border-gray-700 shrink-0 flex justify-between items-center",children:[r.jsxs("div",{children:[r.jsxs("h1",{className:"text-3xl font-bold text-blue-400",children:[r.jsx("i",{className:"fas fa-chalkboard-teacher mr-3"}),"Explainer Video Footage"]}),r.jsx("p",{className:"text-gray-400 text-sm mt-1",children:"Generate libraries of stylistically consistent B-roll footage."})]}),r.jsxs("div",{className:"flex items-center gap-4",children:[r.jsxs("div",{className:"flex gap-2",children:[r.jsx("label",{htmlFor:"import-explainer-project",className:`text-center bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-full transition-all duration-300 flex items-center justify-center gap-2 text-sm shadow-sm ${k?"cursor-not-allowed opacity-50":"cursor-pointer"}`,children:k?r.jsxs(r.Fragment,{children:[r.jsx("i",{className:"fas fa-spinner fa-spin"}),"..."]}):r.jsxs(r.Fragment,{children:[r.jsx("i",{className:"fas fa-folder-open"}),"Import"]})}),r.jsx("input",{id:"import-explainer-project",type:"file",accept:".evdproj",className:"hidden",onChange:je,disabled:k}),r.jsx("button",{onClick:Se,disabled:Q||!F,className:"bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-full disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300 flex items-center justify-center gap-2 text-sm shadow-sm",children:Q?r.jsxs(r.Fragment,{children:[r.jsx("i",{className:"fas fa-spinner fa-spin"}),"..."]}):r.jsxs(r.Fragment,{children:[r.jsx("i",{className:"fas fa-save"}),"Save"]})})]}),De.LOGIN_REQUIRED]})]}),r.jsx("main",{className:"flex-1 overflow-y-auto p-4 md:p-8",children:r.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 xl:grid-cols-4 gap-8 items-start",children:[r.jsx("div",{className:"lg:sticky lg:top-8 xl:col-span-1",children:r.jsx(qe,{script:h,setScript:j,visualStyle:b,setVisualStyle:V,onGenerate:X,isGenerating:u,videoAspectRatio:v,setVideoAspectRatio:B,ttsVoice:w,setTtsVoice:$})}),r.jsx("div",{className:"lg:col-span-2 xl:col-span-3",children:r.jsx(Be,{generationStep:c.length>0?"prompts_generated":"input",scenes:c,isLoading:u,isGeneratingPrompts:!1,error:N,voiceoverScript:h,onVoiceoverScriptChange:j,onGeneratePrompts:X,sceneOverrides:G,onGenerateImage:E,onSceneImagePromptChange:Ie,onSceneVideoPromptChange:Ne,onSceneVoiceoverGuideChange:ke,onSceneEnhancementChange:Ee,onSceneOverrideChange:Ae,onDeleteImage:Ce,onViewImage:L,onUploadImageForVideo:Te,onGenerateAllImages:he,isBatchGenerating:re,onViewStoryboard:()=>z(!0),onDownloadAllImages:()=>Re(c),isDownloadingImages:!1,onDownloadAllVideos:()=>Oe(c),isDownloadingVideos:!1,onSelectImageForVideo:Pe,onGenerateVideo:T,onToggleVideoUpscale:Fe,onUpscaleVideo:P,onGenerateAllVideos:be,isBatchGeneratingVideos:se,onUpscaleAllVideos:ve,isBatchUpscalingVideos:ie,generatedEnvironments:[],onGenerateAudio:C,onGenerateAllAudio:pe,isBatchGeneratingAudio:ne,activeModule:"explainer",onAddScene:me,onPickAllImages:fe,onSendAllImagesToTelegram:xe,isSendingImagesToTelegram:ce,onSendAllVideosToTelegram:ye,isSendingVideosToTelegram:de,videoAspectRatio:v,onToggleDialogueInPrompt:we,onDeleteScene:Ve,onGenerateEnhancedPrompt:Ge,onDeleteVideo:ue})})]})}),R&&r.jsx(Ze,{imageUrl:R,onClose:()=>L(null)}),le&&r.jsx(Le,{scenes:c,onClose:()=>z(!1),videoAspectRatio:v})]})};export{sa as default};
