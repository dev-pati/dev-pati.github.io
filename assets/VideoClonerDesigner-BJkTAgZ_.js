import{r as s,j as n}from"./index-BDGPSugR.js";import{u as E,U as he,g as ia,b as la,a as ca,c as da,r as L,t as ve,s as ga,O as ua,e as ma,d as pa,S as fa,V as ha}from"./telegramService-Cj56laOR.js";import{n as va,o as wa,p as ba,q as ya,c as xa,I as Sa,m as Ia,r as Va}from"./lehuyducanhService-B9F-RCut.js";import{r as x,i as ja,f as we,d as be}from"./media-CDZXYBSY.js";import{I as ye}from"./ImageUpload-cWb71mSq.js";import{s as xe}from"./settingsService-CbIZ9NBp.js";import"./streetInterviewPrompts-Dzu83YwK.js";const Ua=(w,O)=>new Promise((V,m)=>{const u=document.createElement("video");u.preload="metadata",u.src=URL.createObjectURL(w),u.muted=!0;const G=document.createElement("canvas"),P=G.getContext("2d"),F=[];u.onloadedmetadata=()=>{G.width=u.videoWidth,G.height=u.videoHeight;const S=u.duration;if(!S||S===1/0)return URL.revokeObjectURL(u.src),m("Could not determine video duration.");const R=Math.floor(S*O),b=1/O;let A=0,c=0;const C=()=>{if(c>=R||A>S){URL.revokeObjectURL(u.src),V(F);return}u.currentTime=A};u.onseeked=()=>{if(!P)return URL.revokeObjectURL(u.src),m("Canvas context not available");P.drawImage(u,0,0,u.videoWidth,u.videoHeight),F.push(G.toDataURL("image/jpeg",.8)),c++,A+=b,C()},u.onerror=p=>{URL.revokeObjectURL(u.src),m("Error loading or seeking video for frame capture.")},C()},u.onerror=S=>{URL.revokeObjectURL(u.src),m("Error loading video metadata.")}}),Da=({currentUser:w,onLogout:O})=>{const[V,m]=s.useState("upload"),[u,G]=s.useState(null),[P,F]=s.useState(null),[S,R]=s.useState(!1),[b,A]=s.useState(null),[c,C]=s.useState(null),[p,M]=s.useState(null),[f,X]=s.useState(""),[j,_]=s.useState(""),[U,$]=s.useState(""),[Se,Y]=s.useState(!1),[Ie,ee]=s.useState(!1),[I,Ve]=s.useState("9:16"),[N,z]=s.useState(""),[ae,te]=s.useState(!1),[d,g]=s.useState([]),[oe,ne]=s.useState(!1),[K,h]=s.useState(null),[D,je]=s.useState("Kore"),[J,Ue]=s.useState({}),[se,re]=s.useState(null),[Ne,ie]=s.useState(!1),[Ge,le]=s.useState(!1),[Ae,ce]=s.useState(!1),[Ce,de]=s.useState(!1),[ke,ge]=s.useState(!1),[Na,ue]=s.useState(!1),[Ga,me]=s.useState(!1),[Te,pe]=s.useState(!1),[Pe,fe]=s.useState(!1),[Aa,Ee]=s.useState({storyboard:0,image:0,video:0}),k=s.useCallback(()=>{if(w){const e=E.getUsage(w);Ee({storyboard:e.generateStoryboard.count,image:e.generateImage.count,video:e.generateVideo.count})}},[w]);s.useEffect(()=>{k()},[w,k]);const Fe=e=>{var o;const a=(o=e.target.files)==null?void 0:o[0];a&&a.type.startsWith("video/")?(G(a),F(URL.createObjectURL(a)),h(null)):h("Please upload a valid video file.")},Re=async()=>{if(u){R(!0),h(null);try{const a=await Ua(u,2),o=a.length/2,t=await Va(a,2,o);A(t),m("input")}catch(e){h(e instanceof Error?e.message:"An unknown error occurred during video analysis.")}finally{R(!1)}}},De=s.useCallback(async()=>{if(!(!c||!f)){Y(!0);try{const e=await x(c),a=await va(f,e);$(a)}catch(e){h(e instanceof Error?e.message:"Failed to suggest target audience.")}finally{Y(!1)}}},[c,f]),Be=s.useCallback(async()=>{if(!(!c||!f)){ee(!0);try{const e=await x(c),a=await wa(f,e);_(a)}catch(e){h(e instanceof Error?e.message:"Failed to suggest key message.")}finally{ee(!1)}}},[c,f]),Le=s.useCallback(async()=>{if(!(!b||!c||!j)){te(!0),h(null);try{const e=await x(c),a=p?await x(p):void 0,o=await ba(b,j,e,f,U,a);z(o),m("script")}catch(e){h(e instanceof Error?e.message:"Failed to generate cloned script.")}finally{te(!1)}}},[b,j,c,f,U,p]),Oe=s.useCallback(async()=>{if(!(!b||!N||!c)){ne(!0),h(null);try{const e=await x(c),a=p?await x(p):void 0,o=await ya(b,N,e,f,U,a);g(o),m("storyboard")}catch(e){h(e instanceof Error?e.message:"Failed to generate storyboard.")}finally{ne(!1)}}},[b,N,c,f,U,p]),W=s.useCallback(async e=>{if(!E.canPerformAction(w,"generateImage"))throw new Error(`Daily image generation limit of ${he.generateImage} reached.`);const a=d.find(o=>o.id===e);if(a){g(o=>o.map(t=>t.id===e?{...t,isGeneratingImage:!0,imageGenerationError:null}:t));try{const t=(J[e]||{}).imageProvider||"lehuyducanh",r=[];c&&r.push(await x(c)),p&&r.push(await x(p));const l=await ia({provider:t,prompt:a.imagePrompt,subjectUrls:r,aspectRatio:I});g(i=>i.map(v=>v.id===e?{...v,images:[...v.images,...l],isGeneratingImage:!1}:v)),E.logAction(w,"generateImage"),k()}catch(o){const t=o instanceof Error?o.message:"Unknown image generation error.";throw g(r=>r.map(l=>l.id===e?{...l,isGeneratingImage:!1,imageGenerationError:t}:l)),o}}},[d,J,c,p,I,w,k]),Me=(e,a)=>{g(o=>o.map(t=>{if(t.id!==e)return t;const r=[...t.videos];return r.splice(a,1),{...t,videos:r}}))},H=s.useCallback(async e=>{if(!E.canPerformAction(w,"generateVideo"))throw new Error(`Daily video generation limit of ${he.generateVideo} reached.`);const a=d.find(o=>o.id===e);if(!a||!a.selectedImageForVideo)throw new Error("No image selected for video generation.");g(o=>o.map(t=>t.id===e?{...t,isGeneratingVideo:!0,videoGenerationError:null}:t));try{const o=await ja(a.selectedImageForVideo),t=`{
  "voiceover": ${JSON.stringify(a.voiceoverScript)},
  "motion_action": ${JSON.stringify(a.videoPrompt)},
  "audio": {
    "background_music": "none",
    "allow_music": false,
    "allow_sound_effects": true,
    "allow_voiceover": true,
    "policy": "no_music_background_only_sfx_and_voice"
  }
}`,{videoUrl:r,upscaledUrl:l,mediaGenerationId:i,seed:v,publicUrl:y,upscaledPublicUrl:T}=await la({provider:"lehuyducanh",prompt:t,imageUrl:o,upscale:a.shouldUpscaleVideo,aspectRatio:I}),Q={url:y||r,mediaGenerationId:i,seed:v,upscaledUrl:T||l};g(sa=>sa.map(B=>{if(B.id!==e)return B;const ra=[...B.videos,Q];return{...B,videos:ra,isGeneratingVideo:!1}})),E.logAction(w,"generateVideo"),k()}catch(o){const t=o instanceof Error?o.message:"An unknown error occurred.";throw g(r=>r.map(l=>l.id===e?{...l,isGeneratingVideo:!1,videoGenerationError:t}:l)),o}},[d,w,k,I]),Z=s.useCallback(async(e,a)=>{const o=d.find(r=>r.id===e),t=o==null?void 0:o.videos[a];if(t){g(r=>r.map(l=>l.id===e?{...l,videos:l.videos.map((i,v)=>v===a?{...i,isUpscaling:!0,upscaleError:null}:i)}:l));try{const{videoUrl:r,publicUrl:l}=await ca({provider:"lehuyducanh",mediaGenerationId:t.mediaGenerationId,seed:t.seed}),i=l||r;g(v=>v.map(y=>y.id===e?{...y,videos:y.videos.map((T,Q)=>Q===a?{...T,upscaledUrl:i,isUpscaling:!1}:T)}:y))}catch(r){const l=r instanceof Error?r.message:"An unknown error occurred during upscale.";throw g(i=>i.map(v=>v.id===e?{...v,videos:v.videos.map((y,T)=>T===a?{...y,isUpscaling:!1,upscaleError:l}:y)}:v)),r}}},[d]),q=s.useCallback(async e=>{const a=d.find(o=>o.id===e);if(a){g(o=>o.map(t=>t.id===e?{...t,isGeneratingAudio:!0,audioGenerationError:null}:t));try{const o=await xa(a.voiceoverScript,a.voiceoverGuide,D),t=da(o),r=URL.createObjectURL(t);g(l=>l.map(i=>i.id===e?{...i,audioUrl:r,isGeneratingAudio:!1}:i))}catch(o){const t=o instanceof Error?o.message:"An unknown audio generation error occurred.";g(r=>r.map(l=>l.id===e?{...l,isGeneratingAudio:!1,audioGenerationError:t}:l))}}},[d,D]),_e=e=>{const a=Ia({voiceoverScript:"New scene"});g(o=>{const t=[...o];return t.splice(e,0,a),t})},$e=s.useCallback(async()=>{le(!0);const e=d.filter(a=>a.images.length===0).map(a=>()=>W(a.id));await L(e,5),le(!1)},[d,W]),ze=s.useCallback(async()=>{ce(!0);const e=d.filter(a=>!a.audioUrl).map(a=>()=>q(a.id));await L(e,5),ce(!1)},[d,q]),Ke=s.useCallback(async()=>{de(!0);const e=d.filter(a=>a.selectedImageForVideo&&a.videos.length===0).map(a=>()=>H(a.id));await L(e,5),de(!1)},[d,H]),Je=s.useCallback(async()=>{ge(!0);const e=d.flatMap(a=>(a.videos||[]).map((o,t)=>({scene:a,video:o,index:t}))).filter(a=>a.video.url&&a.video.mediaGenerationId&&!a.video.upscaledUrl).map(a=>()=>Z(a.scene.id,a.index));await L(e,5),ge(!1)},[d,Z]),We=s.useCallback(()=>{g(e=>e.map(a=>a.images.length>0?{...a,selectedImageForVideo:a.images[0]}:a)),alert("Picked the first available image for each scene as the video base!")},[]),He=s.useCallback(async()=>{const{botToken:e,chatId:a}=xe.getTelegramConfig();if(!e||!a){alert("Please configure Telegram settings first.");return}const o=d.flatMap((t,r)=>t.images.map((l,i)=>({type:"photo",url:l,caption:`Scene ${r+1}: ${t.voiceoverScript}`,fileName:`${String(r+1).padStart(3,"0")}_image_${String(i+1).padStart(2,"0")}.jpg`})));if(o.length===0){alert("No images to send.");return}pe(!0);try{await ve.sendMedia(o),alert("Images sent to Telegram.")}catch(t){h(t instanceof Error?t.message:"Failed to send images.")}finally{pe(!1)}},[d]),Ze=s.useCallback(async()=>{const{botToken:e,chatId:a}=xe.getTelegramConfig();if(!e||!a){alert("Please configure Telegram settings first.");return}const o=d.flatMap((t,r)=>(t.videos||[]).map((l,i)=>({type:"video",url:l.upscaledUrl||l.url,caption:`Scene ${r+1}: ${t.voiceoverScript}`,fileName:`${String(r+1).padStart(3,"0")}_video_${String(i+1).padStart(2,"0")}.mp4`}))).filter(t=>t.url);if(o.length===0){alert("No videos to send.");return}fe(!0);try{await ve.sendMedia(o),alert("Videos sent to Telegram.")}catch(t){h(t instanceof Error?t.message:"Failed to send videos.")}finally{fe(!1)}},[d]);s.useCallback(async()=>{if(V!=="storyboard"){alert("Please generate a storyboard before saving.");return}ue(!0);try{const e=c?{name:c.name,data:await we(c)}:void 0,a=p?{name:p.name,data:await we(p)}:void 0,o={version:"1.1.0-cloner",analysisResult:b,newProductInfo:f,newBigIdea:j,newTargetAudience:U,script:N,scenes:d,newProductImage:e,newReviewerImage:a,videoAspectRatio:I,ttsVoice:D},t=new Blob([JSON.stringify(o,null,2)],{type:"application/json"});ga(t,"cloner-project.vclproj")}catch(e){h(e instanceof Error?e.message:"Failed to save project")}finally{ue(!1)}},[V,b,c,p,f,j,U,N,d,I,D]),s.useCallback(async e=>{var o,t,r;const a=(o=e.target.files)==null?void 0:o[0];if(a){me(!0);try{const l=await a.text(),i=JSON.parse(l);if(!((t=i.version)!=null&&t.includes("-cloner")))throw new Error("Invalid project file.");A(i.analysisResult||null),X(i.newProductInfo||""),_(i.newBigIdea||""),$(i.newTargetAudience||""),z(i.script||""),g(i.scenes||[]),Ve(i.videoAspectRatio||"9:16"),je(i.ttsVoice||"Kore"),i.newProductImage?C(await be(i.newProductImage.data,i.newProductImage.name)):C(null),i.newReviewerImage?M(await be(i.newReviewerImage.data,i.newReviewerImage.name)):M(null),((r=i.scenes)==null?void 0:r.length)>0?m("storyboard"):i.script?m("script"):i.analysisResult?m("input"):m("upload")}catch(l){h(l instanceof Error?l.message:"Failed to import project")}finally{me(!1)}}},[]);const qe=(e,a)=>g(o=>o.map(t=>t.id===e?{...t,imagePrompt:a}:t)),Qe=(e,a)=>g(o=>o.map(t=>t.id===e?{...t,videoPrompt:a}:t)),Xe=(e,a)=>g(o=>o.map(t=>t.id===e?{...t,voiceoverGuide:a}:t)),Ye=(e,a,o)=>g(t=>t.map(r=>r.id===e?{...r,[a]:o}:r)),ea=(e,a)=>g(o=>o.map(t=>t.id!==e?t:{...t,images:t.images.filter(r=>r!==a),selectedImageForVideo:t.selectedImageForVideo===a?void 0:t.selectedImageForVideo})),aa=(e,a)=>g(o=>o.map(t=>t.id===e?{...t,selectedImageForVideo:a,videos:[],videoGenerationError:null}:t)),ta=async(e,a)=>{try{const o=await x(a);g(t=>t.map(r=>r.id===e?{...r,images:[...r.images,o],selectedImageForVideo:o,videos:[],videoGenerationError:null}:r))}catch{h("Failed to process the uploaded image.")}},oa=e=>g(a=>a.map(o=>o.id===e?{...o,shouldUpscaleVideo:!o.shouldUpscaleVideo}:o)),na=e=>{window.confirm("Are you sure you want to delete this scene? This action cannot be undone.")&&g(a=>a.filter(o=>o.id!==e))};return V==="storyboard"?n.jsxs("div",{className:"flex flex-col h-full",children:[n.jsxs("header",{className:"py-4 px-8 bg-gray-800 shadow-lg border-b border-gray-700 shrink-0 flex justify-between items-center",children:[n.jsx("div",{children:n.jsxs("h1",{className:"text-3xl font-bold text-blue-400",children:[n.jsx("i",{className:"fas fa-clone mr-3"}),"Video Ad Cloner - Storyboard"]})}),n.jsx("div",{className:"flex items-center gap-2",children:n.jsxs("button",{onClick:()=>m("script"),className:"text-sm bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-full",children:[n.jsx("i",{className:"fas fa-arrow-left mr-2"})," Back to Script"]})})]}),n.jsx("main",{className:"flex-1 overflow-y-auto p-4 md:p-8",children:n.jsx(ua,{generationStep:"prompts_generated",scenes:d,isLoading:oe,isGeneratingPrompts:!1,error:K,voiceoverScript:N,onVoiceoverScriptChange:()=>{},onGeneratePrompts:()=>{},sceneOverrides:J,onGenerateImage:W,onSceneImagePromptChange:qe,onSceneVideoPromptChange:Qe,onSceneVoiceoverGuideChange:Xe,onSceneEnhancementChange:Ye,onSceneOverrideChange:(e,a,o)=>Ue(t=>({...t,[e]:{...t[e],[a]:o}})),onDeleteImage:ea,onViewImage:re,onUploadImageForVideo:ta,onGenerateAllImages:$e,isBatchGenerating:Ge,onViewStoryboard:()=>ie(!0),onDownloadAllImages:()=>pa(d),isDownloadingImages:!1,onDownloadAllVideos:()=>ma(d),isDownloadingVideos:!1,onSelectImageForVideo:aa,onGenerateVideo:H,onToggleVideoUpscale:oa,onUpscaleVideo:Z,onGenerateAllVideos:Ke,isBatchGeneratingVideos:Ce,onUpscaleAllVideos:Je,isBatchUpscalingVideos:ke,generatedEnvironments:[],onGenerateAudio:q,onGenerateAllAudio:ze,isBatchGeneratingAudio:Ae,activeModule:"video-cloner",onAddScene:_e,onPickAllImages:We,onSendAllImagesToTelegram:He,isSendingImagesToTelegram:Te,onSendAllVideosToTelegram:Ze,isSendingVideosToTelegram:Pe,videoAspectRatio:I,onToggleDialogueInPrompt:()=>{},onGenerateEnhancedPrompt:()=>{},onDeleteScene:na,onDeleteVideo:Me})}),se&&n.jsx(Sa,{imageUrl:se,onClose:()=>re(null)}),Ne&&n.jsx(fa,{scenes:d,onClose:()=>ie(!1),videoAspectRatio:I})]}):V==="script"?n.jsx("div",{className:"flex flex-col h-full items-center justify-center p-4",children:n.jsxs("div",{className:"w-full max-w-4xl",children:[n.jsx(ha,{script:N,onScriptChange:z,onGenerate:Oe,isGenerating:oe}),n.jsx("div",{className:"flex justify-between items-center mt-4",children:n.jsxs("button",{onClick:()=>m("input"),className:"text-sm bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-full",children:[n.jsx("i",{className:"fas fa-arrow-left mr-2"})," Back to Inputs"]})})]})}):V==="input"?n.jsx("div",{className:"flex flex-col h-full items-center p-4 md:p-8 overflow-y-auto",children:n.jsxs("div",{className:"w-full max-w-4xl bg-gray-800 p-6 rounded-2xl border border-gray-700 space-y-6",children:[n.jsx("h1",{className:"text-3xl font-bold text-blue-400",children:"Step 2: Define New Creative"}),n.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[n.jsx(ye,{id:"new-product",label:"New Product Image",file:c,onFileChange:C}),n.jsx(ye,{id:"new-reviewer",label:"New Reviewer/Character (Optional)",file:p,onFileChange:M})]}),n.jsxs("div",{children:[n.jsx("label",{htmlFor:"new-product-info",className:"block text-md font-bold text-blue-400 mb-2",children:"New Product Info"}),n.jsx("textarea",{id:"new-product-info",value:f,onChange:e=>X(e.target.value),rows:4,className:"w-full bg-gray-700 rounded-lg p-3"})]}),n.jsxs("div",{children:[n.jsx("label",{htmlFor:"new-big-idea",className:"block text-md font-bold text-blue-400 mb-2",children:"New Big Idea / Key Message"}),n.jsxs("div",{className:"flex gap-2 items-center",children:[n.jsx("input",{id:"new-big-idea",type:"text",value:j,onChange:e=>_(e.target.value),className:"w-full bg-gray-700 rounded-lg p-3"}),n.jsx("button",{onClick:Be,disabled:Ie||!c||!f,className:"text-xs shrink-0 bg-purple-600 hover:bg-purple-700 rounded-full px-3 py-2 disabled:opacity-50",children:"Suggest"})]})]}),n.jsxs("div",{children:[n.jsx("label",{htmlFor:"new-target-audience",className:"block text-md font-bold text-blue-400 mb-2",children:"New Target Audience"}),n.jsxs("div",{className:"flex gap-2 items-center",children:[n.jsx("input",{id:"new-target-audience",type:"text",value:U,onChange:e=>$(e.target.value),className:"w-full bg-gray-700 rounded-lg p-3"}),n.jsx("button",{onClick:De,disabled:Se||!c||!f,className:"text-xs shrink-0 bg-purple-600 hover:bg-purple-700 rounded-full px-3 py-2 disabled:opacity-50",children:"Suggest"})]})]}),n.jsxs("div",{className:"flex justify-between items-center pt-4 border-t border-gray-700",children:[n.jsxs("button",{onClick:()=>m("upload"),className:"text-sm bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-full",children:[n.jsx("i",{className:"fas fa-arrow-left mr-2"})," Back"]}),n.jsx("button",{onClick:Le,disabled:ae||!j||!c,className:"bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full text-lg disabled:opacity-50",children:ae?"Generating...":"Generate Script"})]})]})}):n.jsx("div",{className:"flex flex-col h-full items-center justify-center p-4",children:n.jsxs("div",{className:"w-full max-w-2xl text-center",children:[n.jsx("h1",{className:"text-3xl font-bold text-blue-400 mb-4",children:"Step 1: Upload Ad to Clone"}),n.jsx("div",{className:"relative w-full aspect-video bg-gray-800 rounded-lg border-2 border-dashed border-gray-600 flex items-center justify-center",children:P?n.jsx("video",{src:P,controls:!0,className:"w-full h-full rounded-lg"}):n.jsx("p",{className:"text-gray-500",children:"Upload a video to begin"})}),n.jsxs("div",{className:"mt-4 flex justify-center items-center gap-4",children:[n.jsxs("label",{htmlFor:"video-upload",className:"cursor-pointer bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-full",children:[n.jsx("i",{className:"fas fa-upload mr-2"})," Choose Video"]}),n.jsx("input",{id:"video-upload",type:"file",accept:"video/*",onChange:Fe,className:"hidden"}),u&&n.jsx("span",{className:"text-gray-400",children:u.name})]}),n.jsx("button",{onClick:Re,disabled:!u||S,className:"mt-6 w-full max-w-md bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-4 rounded-full disabled:opacity-50 text-xl",children:S?"Analyzing Video...":"Analyze & Proceed"}),K&&n.jsx("p",{className:"text-red-400 mt-4",children:K})]})})};export{Da as default};
